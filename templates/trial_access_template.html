<!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>üå± Plataforma Inteligente de Cr√©ditos de Carbono</title>
        
           
        
        
        <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
        

    </head>
    <body>
        <div class="header">
            <h1>üå± Plataforma Inteligente de Cr√©ditos de Carbono</h1>
            <p>üáßüá∑üá∫üá∏ Intelig√™ncia de Mercado Bilingue Potencializada por IA</p>
        </div>
        
        <div class="container">
            <!-- TRIAL ACCESS FORM -->
            <div class="access-form" id="accessForm">
                <h2>üîë Enter Your Trial Access Key</h2>
                <p>Enter the trial key you received to access the platform</p>
                
                <input type="text" 
                       id="trialKey" 
                       placeholder="CARBON-XXXXXXXXXX" 
                       maxlength="20" 
                       style="text-transform: uppercase;"
                       value="">
                
                <br>
                <button onclick="validateAccess()" class="access-btn" id="accessBtn">
                    ‚úÖ Access Platform
                </button>
                
                <!-- DEBUG INFO -->
                <div class="debug-info" id="debugInfo">
                    <strong>Debug Information:</strong><br>
                    <span id="debugText">Ready to validate...</span>
                </div>
                
                <!-- TEST BUTTON -->
                <div style="margin-top: 15px;">
                    <button onclick="testConnection()" style="background: #666; color: white; padding: 8px 16px; border: none; border-radius: 5px; cursor: pointer; font-size: 12px;">
                        üîß Test Connection
                    </button>
                </div>
            </div>
            
            <!-- TRIAL INFO BANNER -->
            <div class="trial-info-banner" id="trialBanner">
                <p id="trialInfo">‚úÖ Teste Trial Ativo ‚Ä¢ <span id="queriesLeft">100</span> pesquisas restantes ‚Ä¢ <span id="daysLeft">14</span> dias restantes</p>
            </div>
            
            <!-- MAIN PLATFORM INTERFACE -->
            <div class="platform-interface" id="platformInterface">
                <!-- SEARCH INTERFACE -->
                <div class="search-container">
                    <div class="language-detection">
                        üîç <strong>Language Detection:</strong> üáßüá∑ Portuguese (Brazilian) - Location: General
                    </div>
                    
                    <textarea id="searchQuery" class="search-box" 
                              placeholder="Como funciona o mercado volunt√°rio de carbono?"></textarea>
                    
                    <div class="search-buttons">
                        <button onclick="performSearch()" class="search-btn">
                            üîç Buscar Intelig√™ncia de Carbono
                        </button>
                        <button onclick="detectLanguage()" class="detect-btn">
                            üåê Detectar Idioma
                        </button>
                        <button onclick="checkApiStatus()" class="status-btn">
                            ‚ö° Verificar Status da API
                        </button>
                    </div>
                </div>
                
                <!-- EXAMPLES SECTION -->
                <div class="examples">
                    <h3>üí° Quick Examples</h3>
                    
                    <div class="example-grid">
                        <div class="example-item" onclick="useQuery('Onde ser√° a COP30 no Brasil?')">
                            <span class="example-flag">üáßüá∑</span>
                            <span class="example-text">Onde ser√° a COP30 no Brasil?</span>
                        </div>
                        <div class="example-item" onclick="useQuery('Pre√ßos atuais cr√©ditos carbono')">
                            <span class="example-flag">üáßüá∑</span>
                            <span class="example-text">Pre√ßos atuais cr√©ditos carbono</span>
                        </div>
                        <div class="example-item" onclick="useQuery('Carbon credit prices Brazil 2025')">
                            <span class="example-flag">üá∫üá∏</span>
                            <span class="example-text">Carbon credit prices Brazil 2025</span>
                        </div>
                        <div class="example-item" onclick="useQuery('Marco regulat√≥rio carbono brasileiro')">
                            <span class="example-flag">üáßüá∑</span>
                            <span class="example-text">Marco regulat√≥rio carbono brasileiro</span>
                        </div>
                    </div>
                </div>
                
                <!-- RESULTS SECTION -->
                <div id="result"></div>
            </div>
        </div>
        
        <script>
        let currentTrial = null;

        // TEST CONNECTION FUNCTION
        function testConnection() {
            const debugInfo = document.getElementById('debugInfo');
            const debugText = document.getElementById('debugText');
            
            debugInfo.style.display = 'block';
            debugText.innerHTML = 'Testing connection...';
            
            fetch('/health')
                .then(response => response.json())
                .then(data => {
                    debugText.innerHTML = `‚úÖ Connection OK<br>Status: ${data.status}<br>Trials: ${data.total_trials}<br>Time: ${data.server_time}`;
                })
                .catch(error => {
                    debugText.innerHTML = `‚ùå Connection Error: ${error.message}`;
                });
        }
        
        // AUTO-FILL TRIAL KEY FROM REGISTRATION
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded successfully');
            
            // Try to get trial key from localStorage
            const savedTrialKey = localStorage.getItem('carbon_trial_key');
            if (savedTrialKey) {
                document.getElementById('trialKey').value = savedTrialKey;
                
                // Show hint that key was auto-filled
                const debugInfo = document.getElementById('debugInfo');
                const debugText = document.getElementById('debugText');
                debugInfo.style.display = 'block';
                debugText.innerHTML = '‚úÖ Trial key auto-filled from registration. Click "Access Platform" to continue.';
            }
        });
        
        // VALIDATE ACCESS FUNCTION - CORRIGIDO
        async function validateAccess() {
            const trialKey = document.getElementById('trialKey').value.trim().toUpperCase();
            const accessBtn = document.getElementById('accessBtn');
            const debugInfo = document.getElementById('debugInfo');
            const debugText = document.getElementById('debugText');
            const originalText = accessBtn.innerHTML;
            
            debugInfo.style.display = 'block';
            debugText.innerHTML = `Starting validation for key: ${trialKey}`;
            
            if (!trialKey) {
                alert('Please enter your trial access key.');
                debugText.innerHTML = '‚ùå No trial key provided';
                return;
            }
            
            accessBtn.innerHTML = '‚è≥ Validating...';
            accessBtn.disabled = true;
            
            debugText.innerHTML = `Sending request to /validate_trial...`;
            
            try {
                const response = await fetch('/validate_trial', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ trial_key: trialKey })
                });
                
                debugText.innerHTML = `Response received. Status: ${response.status}`;
                
                const result = await response.json();
                debugText.innerHTML = `Response parsed: Success = ${result.success}`;
                
                if (result.success) {
                    currentTrial = result.trial_data;
                    
                    // Hide access form and show platform
                    document.getElementById('accessForm').style.display = 'none';
                    document.getElementById('trialBanner').classList.add('active');
                    document.getElementById('platformInterface').classList.add('active');
                    
                    // Update trial info
                    document.getElementById('queriesLeft').textContent = 100 - result.trial_data.queries_used;
                    document.getElementById('daysLeft').textContent = result.days_remaining;
                    
                    debugText.innerHTML = '‚úÖ Access granted successfully!';
                    
                } else {
                    alert(result.message || 'Invalid trial key.');
                    accessBtn.innerHTML = originalText;
                    accessBtn.disabled = false;
                    debugText.innerHTML = `‚ùå Validation failed: ${result.message}`;
                }
                
            } catch (error) {
                console.error('Validation error:', error);
                alert(`Error validating trial: ${error.message}`);
                accessBtn.innerHTML = originalText;
                accessBtn.disabled = false;
                debugText.innerHTML = `‚ùå Error: ${error.message}`;
            }
        }
        
        function useQuery(query) {
            document.getElementById('searchQuery').value = query;
            performSearch();
        }
        
        // SEARCH FUNCTION
        async function performSearch() {
            const query = document.getElementById('searchQuery').value.trim();
            const resultDiv = document.getElementById('result');
            const searchBtn = document.querySelector('.search-btn');
            const originalText = searchBtn.innerHTML;
            
            if (!query) {
                alert('Please enter a search query.');
                return;
            }
            
            if (!currentTrial) {
                alert('Please login first.');
                return;
            }
            
            searchBtn.innerHTML = 'üîç Searching...';
            searchBtn.disabled = true;
            
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<div class="loading">üîç Searching carbon credits intelligence...</div>';
            
            try {
                const response = await fetch('/search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        query: query,
                        trial_key: currentTrial.trial_key 
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    resultDiv.innerHTML = result.intelligence;
                    document.getElementById('queriesLeft').textContent = result.queries_remaining;
                    
                    searchBtn.innerHTML = '‚úÖ Search Complete!';
                    setTimeout(() => {
                        searchBtn.innerHTML = originalText;
                        searchBtn.disabled = false;
                    }, 2000);
                    
                } else {
                    resultDiv.innerHTML = `
                        <div style="background: #ffebee; color: #c62828; padding: 15px; border-radius: 8px;">
                            <h3>‚ùå Search Error</h3>
                            <p>${result.message}</p>
                        </div>
                    `;
                    searchBtn.innerHTML = originalText;
                    searchBtn.disabled = false;
                }
                
            } catch (error) {
                resultDiv.innerHTML = `
                    <div style="background: #ffebee; color: #c62828; padding: 15px; border-radius: 8px;">
                        <h3>‚ùå Connection Error</h3>
                        <p>Unable to process your search. Please try again.</p>
                    </div>
                `;
                searchBtn.innerHTML = originalText;
                searchBtn.disabled = false;
            }
        }
        
        function detectLanguage() {
            const query = document.getElementById('searchQuery').value.trim();
            if (query) {
                const isPortuguese = /[√†√°√¢√£√§√©√™√´√≠√Æ√Ø√≥√¥√µ√∂√∫√ª√º√ß]/i.test(query) || 
                                   /\\b(o|a|os|as|de|da|do|das|dos|em|para|por|com|sem|sobre)\\b/i.test(query);
                
                const language = isPortuguese ? 'üáßüá∑ Portuguese (Brazilian)' : 'üá∫üá∏ English (US)';
                document.querySelector('.language-detection').innerHTML = 
                    `üîç <strong>Language Detection:</strong> ${language} - Location: General`;
            }
        }
        
        function checkApiStatus() {
            alert('‚úÖ API Status: Online\\nüåê All services operational\\n‚ö° Response time: < 2s');
        }
        
        // Auto-detect language on input
        document.getElementById('searchQuery').addEventListener('input', detectLanguage);
        
        // Allow Enter key for access
        document.getElementById('trialKey').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                validateAccess();
            }
        });
        </script>
    </body>
    </html>